## High-accuracy Optical Delay Measurement System（ODM） 开发日志

**版本：6.3 Beta**

**更新日期：2020.11.1**

万圣节前夕，在东北菜馆吃了锅包肉，喝了一壶米酒，十分开胃；剪完头，打上发胶，精神焕发；毕设开题刚结束，朋友聚会，双 11，学校演出活动等等也将随 2020 的冬天一起到来，因此下定决心解决一些遗留工作。

**按照惯例，以前的版本不再维护。**

距离上次发布的版本已有 2 个月之久，虽然看似不长，但期间经过与傅爷和万胜的讨论，ODM 的某些业务逻辑发生了颠覆性的改动（方案更换）。同时由于自身认知水平的提升，加上以后可能的项目交接，需要留下一个更好为后辈参考、批评、修改的代码，因此也重写了不少，并补上了一些注释。接下来会一一介绍。

===========================================================================

#### 项目结构整理

**背景：** 最早的时候这个项目没有什么项目结构，因为除了 CVI 本身的构建程序外，就只有 4 份 C 代码加 1 个 UI ，当时个人开发觉得无所谓。现在走向了产品化、商业化的道路，项目中包含的内容（包括代码与文档）不断增加，所以为了方便管理，重新整理了下项目结构。

**内容：**

| 目录               | 说明                                                         |
| ------------------ | ------------------------------------------------------------ |
| ./                 | 改动，根目录放置的不必多说，README + CVI 相关构建程序 + 可执行 exe + ui。 |
| ./src              | 新增，源码                                                   |
| ./src/include      | 新增，源码对应的头文件                                       |
| ./src/conf         | 新增，配置文件                                               |
| ./document         | 不变，一些历史文档，包括操作手册，虽然还没有更新，但可以参考。 |
| ./distribution     | 改动，以前的安装包目录改名                                   |
| ./cvibuild.OFDA_V6 | 不变，系统生成的 debug 与 realease 模式运行时的相关文件，一般不用太关心 |
| ./OFDA_V1.2        | 不变，老的精细扫描版本项目                                   |
| ./LicenseServer    | 新增，授权机制变动，激活码业务所需要的加密程序，基于 Node.js 的 Web 应用。 |

其中最大的变化当属新增的 LicenseServer 和配置文件，这两个都是功能性的更新，后面会详细介绍。

===========================================================================

#### 加密授权机制更改——激活码

**背景：** 在之前的版本中，授权加密的方式是 【账号—密码】的形式，需要授权人员提前配置，或通过远程连接，利用【Admin】账户为用户注册【User】账户，并设定试用期。这导致了每次客户想要延长试用期时，都需要远程连接人工操作，重复一次注册流程，并且远程连接本身也不够方便。而在正式购买以后，每次打开系统也需要登录，不够灵活。同时目前团队内部对不同客户的账户信息缺乏统一的，自动化的分配管理机制，也导致过几次忘记客户信息的尴尬。因此本次更新改变了授权机制。

**内容：** 本次更新将授权机制更改为【激活码】的形式。客户端注册界面如图所示。

[![BaB4Qs.png](https://s1.ax1x.com/2020/10/31/BaB4Qs.png)](https://imgchr.com/i/BaB4Qs)

**新的加密机制具有如下特点：**

+ 使用灵活、方便。用户只需要将设备的序列号告知授权人员，就可以获得 4*4 共 16 位的密钥，输入即可获得限时或永久使用期，并且多个激活码可以叠加时长（单个限时激活码最长时间为一年）。
+ 用户的角色被分为普通限时用户【userMode】、永久用户【suserMode】、管理员账户【adminMode】，【userMode】受量程和使用时长限制，【suserMode】只受量程限制，【adminMode】则无任何限制。
+ 同一个激活码无法重复使用。
+ 不同的激活码只能用于对应的设备，其他设备无法使用。

由于激活码需要【输入—加密算法—输出】的流程，同时要对不同的机器及其授权历史进行管理，因此需要进行服务端建设以降低成本。

加密服务位于 ```./LicenseServer``` 文件夹中，出于个人习惯，使用 Node.js 开发，并拥有简单的 WebUI，方便操作人员使用。具体使用方法如下：

+ 如果没有 Node.js 环境，需要先安装 Node.js，官网：https://nodejs.org/en/

+ 将```./LicenseServer```文件夹放置于任何方便或你想要的位置，打开命令行终端并进行启动

  ```shell
  cd $yourpath/LicenseServer
  node server.js
  ```

  出现 ``` Server is running at http://127.0.0.1:6144/``` 即为成功，使用浏览器访问该地址即可。

  [![BarXrR.png](https://s1.ax1x.com/2020/10/31/BarXrR.png)](https://imgchr.com/i/BarXrR)

  按照提示输入信息，比如序列号为 ODM-S-D1000-201010，时长为 200（如果输入 0 就代表永久授权），点击【生成密钥】即可。同时命令行终端也会打印如下日志：

  [![Ba6lbn.png](https://s1.ax1x.com/2020/10/31/Ba6lbn.png)](https://imgchr.com/i/Ba6lbn)

  可以看到，终端打印了许多信息，包括服务的 url，以及具体的请求信息和历史密钥，并将本次的新密钥加入了历史记录，服务端人员可以在指定文件中查看历史密钥。

LicenseServer 的具体实现细节，以后看情况补充。

===========================================================================

#### 利用配置文件自动更改软件运行状态，方便脱机测试+量程修改

**背景：** 在最早的开发阶段（19年毕业季），那时还没有很多针对不同客户量程定制的需求，同时产品化的意识和建设比较少，仅仅是一堆可以完成测量与可视化功能的代码。一开始，修改量程和脱机测试都是直接修改源码完成，似乎也没太大必要把这些参数提取出来（当时的认知局限）。但随着业务和需求的不断增加，产品化导致的许多变动，修改源码的成本也越来越高。同时由于项目只有我一个常驻的维护者，大部分精力都用在上学，而其他成员都是硬件出身，通过远程交流，指导修改源码进行测试越来越困难。所以本次更新对代码进行了优化，将目前业务的可变参数提取了出来，项目结构更加科学，极大地减少了开发、测试及销售的沟通成本。

**内容：** 通过对源码的一些优化和重写，将最大量程【maxLengthIndex】、是否脱机【noComPort】、以及1550和1310光源的插损校准值【 calIL1550】【calIL1310】作为配置文件内容提取了出来。配置文件暂时命名为 conf.dll，目前只需要简单地在第一行写量程对应 Index，第二行写 0 或 1 表示脱机状态，三四行写各自的插损值即可。放置于 ```C:/ProgramData/ODM``` 文件夹下，即可被软件读取，自动更改其运行模式。具体配置参数如下：

**maxLengthIndex：**

| 值   | 意义：最大量程 |
| ---- | -------------- |
| 1    | 100m           |
| 2    | 1km            |
| 3    | 5km            |
| 4    | 10km           |
| 5    | 50km           |
| 6    | 100km          |

**noComPort：**

| 值   | 意义：是否脱机               |
| ---- | ---------------------------- |
| 0    | 联机，用于正式使用与软硬联调 |
| 1    | 脱机，用于脱机开发和测试     |

**calIL1550、calIL1310：**

| 值       | 意义：1550与1310光源对应的插损校准值 |
| -------- | ------------------------------------ |
| 任意数字 | 改变插损校准值                       |

**配置文件内容模板：**

```
3
1
6.5
6
```

上述模板表示开放量程到 5km，脱机状态，1550 校准插损为 6.5 dBm，1310 校准插损为 6 dBm。

默认的 conf.dll 放置于 ```./src/conf/``` 目录中，在 build 打包时，记得按照需求修改配置参数，并保证文件能够安装在 ```C:/ProgramData/ODM``` 下。当然，没有配置文件的话，系统就会按默认配置运行。

===========================================================================

#### 其他更新

+ 修复了用户切换量程只对连续测量图表有影响，而无法影响面板和定时测量图表的问题。现在用户切换量程后，定时与单次测量的图表，以及面板上显示的数值，都会有对应的上下限。
+ 修复了 debug 模式下进行脱机运行时的串口丢失报错问题。
+ 修复了 debug 模式下 UI 线程与计算线程顺序错误与释放的问题。具体表现为若 UI 先关闭，则计算线程仍然会运行，导致找不到 UI 控件的错误；若 UI 后关闭，则在系统初始化循环等待期间，UI 无法立即关闭。
+ 修复了注册界面关闭时，主界面也可能会关闭的问题。
+ 优化、整理了代码结构，添加了一些注释，对控件名、变量名、函数名进行了整理。
+ 优化了中英文翻译部分的代码逻辑。
+ 优化了平均计算模式的测量延迟。

===========================================================================

**WeChat：GCGC5666**

**Email：925016741@qq.com**